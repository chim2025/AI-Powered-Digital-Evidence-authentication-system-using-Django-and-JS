/*
    Advanced YARA Rules for Malicious Process and File Execution Detection
    Author: xAI for evidence_guard
    Date: September 23, 2025
    Description: Detects process injection, suspicious API calls, packed executables, and malicious file operations.
    License: MIT
*/

rule Malicious_Process_Injection {
    meta:
        description = "Detects advanced process injection techniques using Windows APIs"
        author = "xAI"
        severity = "high"
    strings:
        $api_open = "OpenProcess" nocase
        $api_alloc = "VirtualAllocEx" nocase
        $api_write = "WriteProcessMemory" nocase
        $api_thread = "CreateRemoteThread" nocase
        $hex_inject = { 6A 00 6A 04 68 [4] 6A 00 E8 }
    condition:
        all of ($api*) or ($hex_inject at 0x1000 and filesize > 1024)
}

rule Suspicious_Process_Creation {
    meta:
        description = "Identifies suspicious process creation with shellcode or evasion"
        author = "xAI"
        severity = "medium"
    strings:
        $shell_exec = "ShellExecuteA" nocase
        $create_proc = "CreateProcessA" nocase
        $evasion_check = "IsDebuggerPresent" nocase
        $shellcode_sig = { E8 ?? ?? ?? ?? 60 8B }
    condition:
        ($shell_exec or $create_proc) and ($evasion_check or $shellcode_sig)
}

rule Packed_Executable_Detection {
    meta:
        description = "Detects common packer signatures and obfuscated executables"
        author = "xAI"
        severity = "high"
    strings:
        $mz_header = { 4D 5A }
        $upx_sig = "UPX0" nocase
        $aspack_sig = "ASPack" nocase
        $fsg_sig = "FSG!" nocase
        $obf_jump = { E9 ?? ?? ?? ?? 90 }
    condition:
        $mz_header at 0 and 1 of ($upx_sig, $aspack_sig, $fsg_sig, $obf_jump) and filesize < 1048576
}

rule Malicious_File_Execution {
    meta:
        description = "Detects file operations indicative of malware execution"
        author = "xAI"
        severity = "high"
    strings:
        $create_file = "CreateFileA" nocase
        $write_file = "WriteFile" nocase
        $delete_file = "DeleteFileA" nocase
        $autorun_inf = "autorun.inf" nocase
        $temp_drop = "\\Temp\\*.exe" nocase
        $hex_dropper = { 68 ?? ?? ?? ?? 6A 00 6A 00 E8 }
    condition:
        ($create_file or $write_file) and ($delete_file or $autorun_inf or $temp_drop or $hex_dropper)
}

rule Process_Hollowing_Attempt {
    meta:
        description = "Detects process hollowing via NtUnmapViewOfSection"
        author = "xAI"
        severity = "critical"
    strings:
        $nt_unmap = "NtUnmapViewOfSection" nocase
        $virtual_protect = "VirtualProtectEx" nocase
        $hex_hollow = { B8 ?? ?? ?? ?? 8B ?? 6A }
    condition:
        all of them
}